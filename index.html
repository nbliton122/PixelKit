<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Passport Tools — Remove BG (manual download)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#06151a; --panel:#071824; --muted:#9ad9ea; --accent:#7fefff;
    --btn-a-grad: linear-gradient(90deg,#00e6ff,#b86bff);
    --btn-b-grad: linear-gradient(90deg,#6bd1ff,#7be0a9);
    --download1: linear-gradient(90deg,#ff7ad6,#7a8bff);
    --download2: linear-gradient(90deg,#5ce0ff,#00b3ff);
    --download3: linear-gradient(90deg,#ffd16b,#ff7a7a);
    --download4: linear-gradient(90deg,#a28bff,#6fe0ff);
  }
  html,body{height:100%}
  body{font-family:Inter,system-ui,Arial;background:var(--bg);color:#d8fbff;margin:0;padding:22px}
  .wrap{max-width:1100px;margin:0 auto}
  h1{color:var(--accent);margin:0 0 16px;font-weight:700}
  .panel{background:var(--panel);padding:16px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .flex{display:flex;gap:18px;align-items:flex-start}
  .left{flex:0 0 420px}
  .right{flex:1}
  .canvas-wrap{background:linear-gradient(180deg,#0c232b,#071824);padding:12px;border-radius:10px}
  canvas{background:transparent;border-radius:8px;display:block;max-width:100%}
  label{color:var(--muted);display:block;margin-bottom:8px}
  select,input[type=color]{padding:8px;border-radius:8px;border:none;outline:none;background:#0b2b34;color:var(--muted)}
  .controls{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:10px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  .big-buttons{display:flex;gap:12px;margin:10px 0 0}
  .big{padding:10px 14px;border-radius:28px;border:none;cursor:pointer;font-weight:700}
  .big.remove{background:var(--btn-a-grad); color:#06151a}
  .big.passport{background:var(--btn-b-grad); color:#06151a}

  /* Download buttons styled colorful to match your design */
  .dl-row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .dl{padding:10px 12px;border-radius:14px;border:none;color:#071824;cursor:pointer;font-weight:700}
  .dl.png{background:var(--download1)}
  .dl.jpg{background:var(--download2)}
  .dl.psd{background:var(--download3)}
  .dl.removed{background:var(--download4)}

  .small{padding:8px 10px;border-radius:8px;background:#0b2b34;color:var(--muted);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .hint{color:var(--muted);font-size:13px}

  .disabled{opacity:0.6;pointer-events:none}

  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,10,14,0.6);z-index:9999;visibility:hidden;opacity:0;transition:opacity .18s,visibility .18s}
  .overlay.show{visibility:visible;opacity:1}
  .box{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));padding:18px;border-radius:12px;display:flex;gap:14px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .spinner{width:46px;height:46px;border-radius:50%;border:5px solid rgba(255,255,255,0.06);border-top-color:#00e6ff;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loader-text{color:#bfeff7;font-weight:700}
  .loader-sub{color:var(--muted);font-size:13px;margin-top:4px}

  @media(max-width:920px){ .flex{flex-direction:column} .left{flex-basis:auto} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Passport Tools</h1>

  <div class="panel">
    <div class="flex">
      <div class="left">
        <label>Upload portrait</label>
        <input id="file" type="file" accept="image/*">
        <div style="height:12px"></div>

        <div class="canvas-wrap">
          <!-- we draw a checkerboard + transparent person in the preview canvas when "Remove BG" is used -->
          <canvas id="preview" width="360" height="456"></canvas>
        </div>

        <div style="height:10px"></div>
        <div class="muted">Preview (export 450×570)</div>
      </div>

      <div class="right">
        <div class="controls">
          <div>
            <label>Actions</label>
            <div class="big-buttons">
              <button id="btnRemove" class="big remove">Remove Background</button>
              <button id="btnPassport" class="big passport">Passport size & Color make</button>
            </div>
            <div class="hint" style="margin-top:8px">1) Remove BG → processes and enables manual "Download Removed PNG". 2) Passport → create passport composite and enable passport downloads.</div>
          </div>

          <div>
            <label>Background (passport composite)</label>
            <div class="row" style="align-items:center">
              <select id="bgSel">
                <option value="#6ba0e6">Studio color</option>
                <option value="#5d8fe0">Passport blue (old)</option>
                <option value="#5a8bd1">Sample blue 2</option>
                <option value="#4f88c2">Sample blue 3</option>
                <option value="custom">Custom / pick from image</option>
              </select>
              <input id="bgColor" type="color" value="#6ba0e6" style="display:none;margin-left:8px">
            </div>
            <div style="height:8px"></div>
            <button id="pickFromImg" class="small">Pick color from original image</button>
          </div>

          <div>
            <label>Adjustments</label>
            <div class="row"><div style="width:110px;color:var(--muted)">Brightness</div><input id="brightness" type="range" min="-80" max="80" value="6"><div class="muted" id="bVal">+6</div></div>
            <div class="row"><div style="width:110px;color:var(--muted)">Contrast</div><input id="contrast" type="range" min="-80" max="80" value="6"><div class="muted" id="cVal">+6</div></div>
            <div class="row"><div style="width:110px;color:var(--muted)">Feather</div><input id="feather" type="range" min="0" max="30" value="6"><div class="muted" id="fVal">6px</div></div>
          </div>

          <div>
            <label>Downloads</label>
            <div class="dl-row">
              <button id="dlRemoved" class="dl removed" disabled>Download Removed PNG</button>
              <button id="dlPng" class="dl png" disabled>Download PNG</button>
              <button id="dlJpg" class="dl jpg" disabled>Download JPG</button>
              <button id="dlPsd" class="dl psd" disabled>Download PSD</button>
            </div>
            <div style="height:8px"></div>
            <button id="reset" class="small">Reset</button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- hidden original full-size canvas for picking -->
<canvas id="originalCanvas" style="display:none"></canvas>

<!-- overlay loader -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="box" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div>
      <div class="loader-text" id="loaderMain">Processing — please wait…</div>
      <div class="loader-sub" id="loaderSub">Contacting remove.bg</div>
    </div>
  </div>
</div>

<!-- PSD lib -->
<script src="https://cdn.jsdelivr.net/npm/ag-psd@12.0.0/dist/ag-psd.umd.min.js"></script>

<script>
/* remove.bg key (client) */
const REMOVE_BG_KEY = 'jDDFFQjTtwEmhRHP1izPBt5B';

/* DOM refs */
const fileInput = document.getElementById('file');
const btnRemove = document.getElementById('btnRemove');
const btnPassport = document.getElementById('btnPassport');
const preview = document.getElementById('preview'), ctx = preview.getContext('2d');
const originalCanvas = document.getElementById('originalCanvas'), origCtx = originalCanvas.getContext('2d');

const bgSel = document.getElementById('bgSel'), bgColor = document.getElementById('bgColor'), pickFromImg = document.getElementById('pickFromImg');
const brightness = document.getElementById('brightness'), contrast = document.getElementById('contrast'), feather = document.getElementById('feather');
const bVal = document.getElementById('bVal'), cVal = document.getElementById('cVal'), fVal = document.getElementById('fVal');

const dlRemoved = document.getElementById('dlRemoved');
const dlPng = document.getElementById('dlPng'), dlJpg = document.getElementById('dlJpg'), dlPsd = document.getElementById('dlPsd');
const resetBtn = document.getElementById('reset');

const overlay = document.getElementById('overlay');
const loaderMain = document.getElementById('loaderMain'), loaderSub = document.getElementById('loaderSub');

let uploadedFile = null;
let origImage = null;
let removedBlob = null;            // blob from remove.bg (transparent png) for manual download
let latestPassportCanvas = null;  // final passport composite
let picking = false;

/* hide on-page logs; use console */
function log(...t){ console.log(...t); }

/* UI bindings */
bgSel.addEventListener('change', ()=> {
  bgColor.style.display = bgSel.value === 'custom' ? 'inline-block' : 'none';
  if(bgSel.value !== 'custom') bgColor.value = bgSel.value;
  updatePreviewBackground();
});
bgColor.addEventListener('input', updatePreviewBackground);
pickFromImg.addEventListener('click', ()=> {
  if(!origImage) return alert('Upload image first');
  picking = true;
  drawPreviewScaled(origImage);
  alert('Pick mode: click the preview to sample a color.');
});

brightness.addEventListener('input', ()=> { bVal.textContent = (brightness.value>0?'+':'')+brightness.value; });
contrast.addEventListener('input', ()=> { cVal.textContent = (contrast.value>0?'+':'')+contrast.value; });
feather.addEventListener('input', ()=> { fVal.textContent = feather.value + 'px'; });

/* file load */
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  uploadedFile = f;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = ()=>{
    origImage = img;
    drawPreviewScaled(img);
    originalCanvas.width = img.width; originalCanvas.height = img.height;
    origCtx.clearRect(0,0,originalCanvas.width, originalCanvas.height);
    origCtx.drawImage(img,0,0);
    URL.revokeObjectURL(url);
    log('Loaded', img.width, img.height);
    updatePreviewBackground();
  };
  img.src = url;
});

/* draw scaled preview of original image (for pick mode and default) */
function drawPreviewScaled(img){
  const maxW = 360, maxH = 456;
  const w = img.width, h = img.height;
  const ratio = Math.min(maxW/w, maxH/h, 1);
  const dw = Math.round(w*ratio), dh = Math.round(h*ratio);
  preview.width = dw; preview.height = dh;
  ctx.clearRect(0,0,dw,dh);
  ctx.drawImage(img, 0,0,w,h, 0,0,dw,dh);
}

/* preview click for picking color */
preview.addEventListener('click', (ev)=>{
  if(!picking || !origImage) return;
  const rect = preview.getBoundingClientRect();
  const cx = ev.clientX - rect.left, cy = ev.clientY - rect.top;
  const scaleX = origImage.width / preview.width;
  const scaleY = origImage.height / preview.height;
  const ox = Math.floor(cx * scaleX), oy = Math.floor(cy * scaleY);
  if(ox<0||oy<0||ox>=originalCanvas.width||oy>=originalCanvas.height) { picking=false; return; }
  const pd = origCtx.getImageData(ox,oy,1,1).data;
  const hex = rgbToHex(pd[0],pd[1],pd[2]);
  bgSel.value = 'custom'; bgColor.style.display = 'inline-block'; bgColor.value = hex;
  picking = false;
  drawPreviewScaled(origImage);
  updatePreviewBackground();
});

/* Draw checkerboard background for preview when showing transparent person */
function drawChecker(width, height, size=12){
  // draw small checkerboard into preview canvas
  ctx.clearRect(0,0,preview.width,preview.height);
  const cols = Math.ceil(width / size), rows = Math.ceil(height / size);
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      ctx.fillStyle = ((x+y)%2===0) ? '#c9dfe6' : '#f5fbff';
      // but scale checker to preview size, so use fillRect with scaled positions:
      const cw = preview.width / cols;
      const ch = preview.height / rows;
      ctx.fillStyle = ((x+y)%2===0) ? '#c9dfe6' : '#f5fbff';
      ctx.fillRect(x*cw, y*ch, cw, ch);
    }
  }
}

/* instant preview update when selecting bg or after other ops */
function updatePreviewBackground(){
  let bg = bgSel.value === 'custom' ? (bgColor.value || '#6ba0e6') : bgSel.value;
  if(!preview.width || !preview.height){ preview.width = 360; preview.height = 456; }
  ctx.save();
  ctx.clearRect(0,0,preview.width,preview.height);
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,preview.width,preview.height);

  if(latestPassportCanvas){
    ctx.drawImage(latestPassportCanvas, 0,0, latestPassportCanvas.width, latestPassportCanvas.height, 0,0, preview.width, preview.height);
  } else if(origImage){
    const w = origImage.width, h = origImage.height;
    const ratio = Math.min(preview.width / w, preview.height / h, 1);
    const dw = Math.round(w * ratio), dh = Math.round(h * ratio);
    const dx = Math.round((preview.width - dw)/2), dy = Math.round((preview.height - dh)/2);
    ctx.drawImage(origImage, 0,0,w,h, dx, dy, dw, dh);
  }
  ctx.restore();
}

/* overlay */
function showLoader(main='Processing — please wait…', sub='Contacting remove.bg'){
  document.getElementById('overlay').classList.add('show');
  loaderMain.textContent = main;
  loaderSub.textContent = sub;
  // disable
  btnRemove.classList.add('disabled'); btnPassport.classList.add('disabled');
  fileInput.disabled = true; pickFromImg.disabled = true; bgSel.disabled = true; bgColor.disabled = true;
  brightness.disabled = true; contrast.disabled = true; feather.disabled = true;
  dlRemoved.disabled = true; dlPng.disabled = true; dlJpg.disabled = true; dlPsd.disabled = true;
}
function hideLoader(){
  document.getElementById('overlay').classList.remove('show');
  btnRemove.classList.remove('disabled'); btnPassport.classList.remove('disabled');
  fileInput.disabled = false; pickFromImg.disabled = false; bgSel.disabled = false; bgColor.disabled = false;
  brightness.disabled = false; contrast.disabled = false; feather.disabled = false;
  // enable depending on state
  if(removedBlob) dlRemoved.disabled = false;
  if(latestPassportCanvas){ dlPng.disabled = false; dlJpg.disabled = false; dlPsd.disabled = false; }
}

/* Remove Background: process but DO NOT auto-download.
   Save blob in removedBlob and enable dlRemoved button. Also show transparent person over checker preview.
*/
btnRemove.addEventListener('click', async ()=>{
  if(!uploadedFile) return alert('Choose an image first');
  try{
    showLoader('Removing background…', 'Uploading to remove.bg');
    const blob = await callRemoveBg(uploadedFile);
    removedBlob = blob;
    // show transparent person on checkerboard so user can inspect
    const img = await blobToImage(blob);
    // draw checker then person centered
    drawChecker(preview.width, preview.height, 12);
    // draw person scaled to preview
    const srcRatio = img.width / img.height;
    const destRatio = preview.width / preview.height;
    let drawW, drawH;
    if(srcRatio > destRatio){
      drawH = preview.height;
      drawW = Math.round(img.width * (preview.height / img.height));
    } else {
      drawW = preview.width;
      drawH = Math.round(img.height * (preview.width / img.width));
    }
    const dx = Math.round((preview.width - drawW)/2), dy = Math.round((preview.height - drawH)/2);
    ctx.drawImage(img, dx, dy, drawW, drawH);
    // enable manual download button
    dlRemoved.disabled = false;
    hideLoader();
    log('Removed bg processed — click "Download Removed PNG" to save manually.');
  }catch(err){
    hideLoader();
    console.error(err);
    alert('Error: ' + (err.message || err));
  }
});

/* manual download for removed PNG */
dlRemoved.addEventListener('click', ()=>{
  if(!removedBlob) return alert('No removed image available. Click Remove Background first.');
  downloadBlob(removedBlob, 'removed_bg.png');
});

/* Passport generator flow (same as before) */
btnPassport.addEventListener('click', async ()=>{
  if(!uploadedFile) return alert('Choose an image first');
  try{
    showLoader('Creating passport image…', 'Uploading to remove.bg');
    const pngBlob = await callRemoveBg(uploadedFile);
    const personImg = await blobToImage(pngBlob);
    const passportCanvas = compositePassport(personImg);
    latestPassportCanvas = passportCanvas;
    showPassportPreview(passportCanvas);
    hideLoader();
    log('Passport ready');
  }catch(err){
    hideLoader();
    console.error(err);
    alert('Error: ' + (err.message || err));
  }
});

/* remove.bg call */
async function callRemoveBg(file){
  const url = 'https://api.remove.bg/v1.0/removebg';
  const form = new FormData();
  form.append('image_file', file);
  form.append('size', 'auto');
  const controller = new AbortController();
  const timeout = setTimeout(()=> controller.abort(), 70000);
  try{
    const res = await fetch(url, { method:'POST', headers:{ 'X-Api-Key': REMOVE_BG_KEY }, body: form, signal: controller.signal });
    clearTimeout(timeout);
    if(!res.ok){
      const txt = await res.text();
      throw new Error('remove.bg failed: ' + res.status + ' ' + txt);
    }
    return await res.blob();
  }catch(e){
    clearTimeout(timeout);
    throw e;
  }
}

/* helpers */
function blobToImage(blob){
  return new Promise((res, rej)=>{
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = ()=>{ URL.revokeObjectURL(url); res(img); };
    img.onerror = (e)=>{ URL.revokeObjectURL(url); rej(e); };
    img.src = url;
  });
}
function downloadBlob(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
}

/* passport composite (450x570) */
function compositePassport(personImg){
  const OUT_W = 450, OUT_H = 570;
  const c = document.createElement('canvas'); c.width = OUT_W; c.height = OUT_H;
  const cctx = c.getContext('2d');

  let bg = bgSel.value;
  if(bg === 'custom') bg = bgColor.value || '#6ba0e6';
  cctx.fillStyle = bg; cctx.fillRect(0,0,OUT_W,OUT_H);

  const srcRatio = personImg.width / personImg.height;
  const destRatio = OUT_W / OUT_H;
  let drawW, drawH;
  if(srcRatio > destRatio){
    drawH = OUT_H;
    drawW = Math.round(personImg.width * (OUT_H / personImg.height));
  } else {
    drawW = OUT_W;
    drawH = Math.round(personImg.height * (OUT_W / personImg.width));
  }
  const dx = Math.round((OUT_W - drawW) / 2), dy = Math.round((OUT_H - drawH) / 2);
  cctx.drawImage(personImg, dx, dy, drawW, drawH);

  applyBrightnessContrast(c, Number(brightness.value), Number(contrast.value));
  despillCanvas(c, bg, 0.88);

  return c;
}

/* show passport preview scaled */
function showPassportPreview(canvas){
  latestPassportCanvas = canvas;
  preview.width = Math.min(420, canvas.width);
  preview.height = Math.round(preview.width * canvas.height / canvas.width);
  ctx.clearRect(0,0,preview.width,preview.height);
  ctx.drawImage(canvas, 0,0, canvas.width, canvas.height, 0,0, preview.width, preview.height);
  // enable downloads
  dlPng.disabled = false; dlJpg.disabled = false; dlPsd.disabled = false;
}

/* image operations */
function applyBrightnessContrast(canvas, bright=0, contrastVal=0){
  const ctx2 = canvas.getContext('2d');
  const img = ctx2.getImageData(0,0,canvas.width,canvas.height);
  const data = img.data;
  const b = bright;
  const c = contrastVal/100;
  const factor = (259 * (c*255 + 255)) / (255 * (259 - c*255) || 1);
  for(let i=0;i<data.length;i+=4){
    data[i] = clamp(factor * (clamp(data[i] + b) - 128) + 128);
    data[i+1] = clamp(factor * (clamp(data[i+1] + b) - 128) + 128);
    data[i+2] = clamp(factor * (clamp(data[i+2] + b) - 128) + 128);
  }
  ctx2.putImageData(img,0,0);
}
function despillCanvas(canvas, bgHex='#6ba0e6', strength=0.85){
  const ctx2 = canvas.getContext('2d');
  const img = ctx2.getImageData(0,0,canvas.width,canvas.height);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    if(b > r + 12 && b > g + 12){
      const diff = b - Math.max(r,g);
      const reduce = Math.round(diff * strength);
      d[i+2] = clamp(b - reduce);
      d[i] = clamp(r + Math.round(reduce * 0.05));
      d[i+1] = clamp(g + Math.round(reduce * 0.03));
    }
  }
  ctx2.putImageData(img,0,0);
}
function clamp(v){ return Math.max(0, Math.min(255, Math.round(v))); }
function rgbToHex(r,g,b){ return '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join(''); }

/* downloads for passport */
dlPng.addEventListener('click', ()=>{
  if(!latestPassportCanvas) return alert('Generate passport first');
  latestPassportCanvas.toBlob(b => downloadBlob(b, 'passport.png'), 'image/png');
});
dlJpg.addEventListener('click', ()=>{
  if(!latestPassportCanvas) return alert('Generate passport first');
  latestPassportCanvas.toBlob(b => downloadBlob(b, 'passport.jpg'), 'image/jpeg', 0.92);
});
dlPsd.addEventListener('click', ()=>{
  if(!latestPassportCanvas) return alert('Generate passport first');
  try{
    const ag = window['agPsd'];
    const psd = { width: latestPassportCanvas.width, height: latestPassportCanvas.height, children: [ { name: 'Layer 1', left:0, top:0, right: latestPassportCanvas.width, bottom: latestPassportCanvas.height, canvas: latestPassportCanvas } ] };
    const ab = ag.encodePsd(psd);
    const blob = new Blob([ab], { type: 'application/octet-stream' });
    downloadBlob(blob, 'passport.psd');
  }catch(e){
    console.error(e);
    alert('PSD export failed: ' + (e.message || e));
  }
});

/* reset */
resetBtn.addEventListener('click', ()=> {
  uploadedFile = null; origImage = null; removedBlob = null; latestPassportCanvas = null; fileInput.value = '';
  ctx.clearRect(0,0,preview.width,preview.height);
  dlRemoved.disabled = dlPng.disabled = dlJpg.disabled = dlPsd.disabled = true;
  updatePreviewBackground();
});

/* utility to draw checker (used earlier) when previewing removed image.
   This will draw visible checkers scaled to preview size even if img differs.
*/
function drawChecker(width, height, size=12){
  // we reuse the canvas width/height for scaled checker pattern
  const cols = Math.ceil(width / size), rows = Math.ceil(height / size);
  const cw = preview.width / cols;
  const ch = preview.height / rows;
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      ctx.fillStyle = ((x+y)%2===0) ? '#c9dfe6' : '#f5fbff';
      ctx.fillRect(x*cw, y*ch, cw, ch);
    }
  }
}
</script>
</body>
</html>
