<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Passport Tools — Multi-API Keys</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#06151a;--panel:#071824;--muted:#9ad9ea;--accent:#7fefff}
  body{font-family:Inter,system-ui,Arial;background:var(--bg);color:#d8fbff;margin:0;padding:22px}
  .wrap{max-width:1100px;margin:0 auto}
  h1{color:var(--accent);margin:0 0 16px;font-weight:700}
  .panel{background:var(--panel);padding:16px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .flex{display:flex;gap:18px;align-items:flex-start}
  .left{flex:0 0 420px}
  .right{flex:1}
  .canvas-wrap{background:linear-gradient(180deg,#0c232b,#071824);padding:12px;border-radius:10px}
  canvas{background:transparent;border-radius:8px;display:block;max-width:100%}
  label{color:var(--muted);display:block;margin-bottom:8px}
  select,input[type=color]{padding:8px;border-radius:8px;border:none;outline:none;background:#0b2b34;color:var(--muted)}
  .controls{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:10px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  .big-buttons{display:flex;gap:12px;margin:10px 0 0}
  .big{padding:10px 14px;border-radius:28px;border:none;cursor:pointer;font-weight:700}
  .big.remove{background:linear-gradient(90deg,#00e6ff,#b86bff); color:#06151a}
  .big.passport{background:linear-gradient(90deg,#6bd1ff,#7be0a9); color:#06151a}
  .dl-row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .dl{padding:10px 12px;border-radius:14px;border:none;color:#071824;cursor:pointer;font-weight:700}
  .dl.png{background:linear-gradient(90deg,#ff7ad6,#7a8bff)}
  .dl.jpg{background:linear-gradient(90deg,#5ce0ff,#00b3ff)}
  .dl.psd{background:linear-gradient(90deg,#ffd16b,#ff7a7a)}
  .dl.removed{background:linear-gradient(90deg,#a28bff,#6fe0ff)}
  .small{padding:8px 10px;border-radius:8px;background:#0b2b34;color:var(--muted);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .hint{color:var(--muted);font-size:13px}
  .disabled{opacity:0.6;pointer-events:none}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,10,14,0.6);z-index:9999;visibility:hidden;opacity:0;transition:opacity .18s,visibility .18s}
  .overlay.show{visibility:visible;opacity:1}
  .box{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));padding:18px;border-radius:12px;display:flex;gap:14px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .spinner{width:46px;height:46px;border-radius:50%;border:5px solid rgba(255,255,255,0.06);border-top-color:#00e6ff;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loader-text{color:#bfeff7;font-weight:700}
  .loader-sub{color:var(--muted);font-size:13px;margin-top:4px}
  @media(max-width:920px){ .flex{flex-direction:column} .left{flex-basis:auto} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Passport Maker Tools — </h1>

  <div class="panel">
    <div class="flex">
      <div class="left">
        <label>Upload portrait</label>
        <input id="file" type="file" accept="image/*">
        <div style="height:12px"></div>
        <div class="canvas-wrap">
          <canvas id="preview" width="360" height="456"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="muted">Preview (export 450×570)</div>
      </div>

      <div class="right">
        <div class="controls">
          <div>
            <label>Actions</label>
            <div class="big-buttons">
              <button id="btnRemove" class="big remove">Remove Background</button>
              <button id="btnPassport" class="big passport">Passport size & Color make</button>
            </div>
            <div class="hint" style="margin-top:8px">Remove → produce removed PNG (manual download). Passport → composite and enable passport downloads.</div>
          </div>

          <div>
            <label>Background (passport composite)</label>
            <div class="row" style="align-items:center">
              <select id="bgSel">
                <option value="#6ba0e6">Studio color</option>
                <option value="#5d8fe0">Passport blue (old)</option>
                <option value="#5a8bd1">Sample blue 2</option>
                <option value="#4f88c2">Sample blue 3</option>
                <option value="custom">Custom / pick from image</option>
              </select>
              <input id="bgColor" type="color" value="#6ba0e6" style="display:none;margin-left:8px">
            </div>
            <div style="height:8px"></div>
            <button id="pickFromImg" class="small">Pick color from original image</button>
          </div>

          <div>
            <label>Adjustments</label>
            <div class="row"><div style="width:110px;color:var(--muted)">Brightness</div><input id="brightness" type="range" min="-80" max="80" value="6"><div class="muted" id="bVal">+6</div></div>
            <div class="row"><div style="width:110px;color:var(--muted)">Contrast</div><input id="contrast" type="range" min="-80" max="80" value="6"><div class="muted" id="cVal">+6</div></div>
            <div class="row"><div style="width:110px;color:var(--muted)">Feather</div><input id="feather" type="range" min="0" max="30" value="6"><div class="muted" id="fVal">6px</div></div>
          </div>

          <div>
            <label>Downloads</label>
            <div class="dl-row">
              <button id="dlRemoved" class="dl removed" disabled>Download Removed PNG</button>
              <button id="dlPng" class="dl png" disabled>Download PNG</button>
              <button id="dlJpg" class="dl jpg" disabled>Download JPG</button>
              <button id="dlPsd" class="dl psd" disabled>Download PSD</button>
            </div>
            <div style="height:8px"></div>
            <button id="reset" class="small">Reset</button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<canvas id="originalCanvas" style="display:none"></canvas>

<div id="overlay" class="overlay" aria-hidden="true">
  <div class="box" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div>
      <div class="loader-text" id="loaderMain">Processing — please wait…</div>
      <div class="loader-sub" id="loaderSub">Contacting remove.bg</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-psd@12.0.0/dist/ag-psd.umd.min.js"></script>

<script>
/*
  Multi API key handling:
  - You supplied multiple remove.bg API keys; they are placed in API_KEYS array.
  - callRemoveBg() will try each key in order until one returns OK.
*/

// ---- Put your keys here (I added the ones you gave) ----
const API_KEYS = [
  'jDDFFQjTtwEmhRHP1izPBt5B', // previous key (if still valid)
  'jXyEt5XsWQPmZSS8nuBepW7p',
  'La7emWvo6NcHSDv3HoLbSRMh'
];

// DOM refs
const fileInput = document.getElementById('file');
const btnRemove = document.getElementById('btnRemove');
const btnPassport = document.getElementById('btnPassport');
const preview = document.getElementById('preview'), ctx = preview.getContext('2d');
const origCanvas = document.getElementById('originalCanvas'), origCtx = origCanvas.getContext('2d');

const bgSel = document.getElementById('bgSel'), bgColor = document.getElementById('bgColor'), pickFromImg = document.getElementById('pickFromImg');
const brightness = document.getElementById('brightness'), contrast = document.getElementById('contrast'), feather = document.getElementById('feather');
const bVal = document.getElementById('bVal'), cVal = document.getElementById('cVal'), fVal = document.getElementById('fVal');

const dlRemoved = document.getElementById('dlRemoved');
const dlPng = document.getElementById('dlPng'), dlJpg = document.getElementById('dlJpg'), dlPsd = document.getElementById('dlPsd');
const resetBtn = document.getElementById('reset');

const overlay = document.getElementById('overlay');
const loaderMain = document.getElementById('loaderMain'), loaderSub = document.getElementById('loaderSub');

let uploadedFile = null;
let origImage = null;
let removedBlob = null;
let latestPassportCanvas = null;
let picking = false;

function log(...t){ console.log(...t); }

// UI binds
bgSel.addEventListener('change', ()=> {
  bgColor.style.display = bgSel.value === 'custom' ? 'inline-block' : 'none';
  if(bgSel.value !== 'custom') bgColor.value = bgSel.value;
  updatePreviewBackground();
});
bgColor.addEventListener('input', updatePreviewBackground);
pickFromImg.addEventListener('click', ()=> {
  if(!origImage) return alert('Upload image first');
  picking = true;
  drawPreviewScaled(origImage);
  alert('Pick mode: click the preview to sample a color.');
});

brightness.addEventListener('input', ()=> { bVal.textContent = (brightness.value>0?'+':'')+brightness.value; });
contrast.addEventListener('input', ()=> { cVal.textContent = (contrast.value>0?'+':'')+contrast.value; });
feather.addEventListener('input', ()=> { fVal.textContent = feather.value + 'px'; });

// file load
fileInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  uploadedFile = f;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = ()=>{
    origImage = img;
    drawPreviewScaled(img);
    origCanvas.width = img.width; origCanvas.height = img.height;
    origCtx.clearRect(0,0,origCanvas.width, origCanvas.height);
    origCtx.drawImage(img,0,0);
    URL.revokeObjectURL(url);
    log('Loaded', img.width, img.height);
    updatePreviewBackground();
  };
  img.src = url;
});

function drawPreviewScaled(img){
  const maxW = 360, maxH = 456;
  const w = img.width, h = img.height;
  const ratio = Math.min(maxW/w, maxH/h, 1);
  const dw = Math.round(w*ratio), dh = Math.round(h*ratio);
  preview.width = dw; preview.height = dh;
  ctx.clearRect(0,0,dw,dh);
  ctx.drawImage(img, 0,0,w,h, 0,0,dw,dh);
}

preview.addEventListener('click', (ev)=>{
  if(!picking || !origImage) return;
  const rect = preview.getBoundingClientRect();
  const cx = ev.clientX - rect.left, cy = ev.clientY - rect.top;
  const scaleX = origImage.width / preview.width;
  const scaleY = origImage.height / preview.height;
  const ox = Math.floor(cx * scaleX), oy = Math.floor(cy * scaleY);
  if(ox<0||oy<0||ox>=origCanvas.width||oy>=origCanvas.height) { picking=false; return; }
  const pd = origCtx.getImageData(ox,oy,1,1).data;
  const hex = rgbToHex(pd[0],pd[1],pd[2]);
  bgSel.value = 'custom'; bgColor.style.display = 'inline-block'; bgColor.value = hex;
  picking = false;
  drawPreviewScaled(origImage);
  updatePreviewBackground();
});

/* update preview background instantly */
function updatePreviewBackground(){
  let bg = bgSel.value === 'custom' ? (bgColor.value || '#6ba0e6') : bgSel.value;
  if(!preview.width || !preview.height){ preview.width = 360; preview.height = 456; }
  ctx.save();
  ctx.clearRect(0,0,preview.width,preview.height);
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,preview.width,preview.height);

  if(latestPassportCanvas){
    ctx.drawImage(latestPassportCanvas, 0,0, latestPassportCanvas.width, latestPassportCanvas.height, 0,0, preview.width, preview.height);
  } else if(origImage){
    const w = origImage.width, h = origImage.height;
    const ratio = Math.min(preview.width / w, preview.height / h, 1);
    const dw = Math.round(w * ratio), dh = Math.round(h * ratio);
    const dx = Math.round((preview.width - dw)/2), dy = Math.round((preview.height - dh)/2);
    ctx.drawImage(origImage, 0,0,w,h, dx, dy, dw, dh);
  }
  ctx.restore();
}

/* overlay controls */
function showLoader(main='Processing — please wait…', sub='Contacting remove.bg'){
  document.getElementById('overlay').classList.add('show');
  loaderMain.textContent = main;
  loaderSub.textContent = sub;
  btnRemove.classList.add('disabled'); btnPassport.classList.add('disabled');
  fileInput.disabled = true; pickFromImg.disabled = true; bgSel.disabled = true; bgColor.disabled = true;
  brightness.disabled = true; contrast.disabled = true; feather.disabled = true;
  dlRemoved.disabled = true; dlPng.disabled = true; dlJpg.disabled = true; dlPsd.disabled = true;
}
function hideLoader(){
  document.getElementById('overlay').classList.remove('show');
  btnRemove.classList.remove('disabled'); btnPassport.classList.remove('disabled');
  fileInput.disabled = false; pickFromImg.disabled = false; bgSel.disabled = false; bgColor.disabled = false;
  brightness.disabled = false; contrast.disabled = false; feather.disabled = false;
  if(removedBlob) dlRemoved.disabled = false;
  if(latestPassportCanvas){ dlPng.disabled = false; dlJpg.disabled = false; dlPsd.disabled = false; }
}

/* ===== updated remove.bg caller with key rotation =====
   - Tries each API key from API_KEYS in order.
   - If response.ok -> returns blob immediately.
   - If response status indicates auth/error/quota (401/402/403/429/5xx), try next key.
   - Collects errors for final reporting.
*/
async function callRemoveBgWithRotation(file){
  const url = 'https://api.remove.bg/v1.0/removebg';
  const errors = [];
  for(const key of API_KEYS){
    try{
      // small UI hint
      log('Trying remove.bg with key:', key.slice(0,6) + '…');
      const form = new FormData();
      form.append('image_file', file);
      form.append('size', 'auto');

      const controller = new AbortController();
      const timeoutId = setTimeout(()=> controller.abort(), 70000);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-Api-Key': key },
        body: form,
        signal: controller.signal
      });
      clearTimeout(timeoutId);

      if(res.ok){
        log('remove.bg success with key:', key.slice(0,8));
        return await res.blob();
      } else {
        const txt = await res.text().catch(()=> '');
        const errMsg = `Key ${key.slice(0,6)} failed: ${res.status} ${txt}`;
        errors.push(errMsg);
        log(errMsg);
        // try next key
        continue;
      }
    }catch(err){
      const s = err && err.name === 'AbortError' ? 'timeout' : (err.message || err);
      const errMsg = `Key ${key.slice(0,6)} error: ${s}`;
      errors.push(errMsg);
      log(errMsg);
      // try next key
      continue;
    }
  }
  // all keys failed
  throw new Error('All API keys failed. Details:\\n' + errors.join('\\n'));
}

/* Button: Remove Background (no auto download) */
btnRemove.addEventListener('click', async ()=>{
  if(!uploadedFile) return alert('Choose an image first');
  try{
    showLoader('Removing background…', 'Trying API keys');
    const blob = await callRemoveBgWithRotation(uploadedFile);
    removedBlob = blob;
    // show checker + transparent person
    const img = await blobToImage(blob);
    drawChecker(preview.width, preview.height, 12);
    // draw person centered scaled
    const srcRatio = img.width / img.height;
    const destRatio = preview.width / preview.height;
    let drawW, drawH;
    if(srcRatio > destRatio){
      drawH = preview.height; drawW = Math.round(img.width * (preview.height / img.height));
    } else {
      drawW = preview.width; drawH = Math.round(img.height * (preview.width / img.width));
    }
    const dx = Math.round((preview.width - drawW)/2), dy = Math.round((preview.height - drawH)/2);
    ctx.drawImage(img, dx, dy, drawW, drawH);
    dlRemoved.disabled = false;
    hideLoader();
    log('Removed PNG ready (manual download).');
  }catch(err){
    hideLoader();
    console.error(err);
    alert('Remove BG failed: ' + (err.message || err));
  }
});

/* Use the rotated caller for passport flow as well */
btnPassport.addEventListener('click', async ()=>{
  if(!uploadedFile) return alert('Choose an image first');
  try{
    showLoader('Creating passport image…', 'Trying API keys');
    const blob = await callRemoveBgWithRotation(uploadedFile);
    const personImg = await blobToImage(blob);
    const passportCanvas = compositePassport(personImg);
    latestPassportCanvas = passportCanvas;
    showPassportPreview(passportCanvas);
    hideLoader();
    log('Passport ready');
  }catch(err){
    hideLoader();
    console.error(err);
    alert('Passport creation failed: ' + (err.message || err));
  }
});

/* callRemoveBgWithRotation uses blobToImage, downloadBlob etc. */
function blobToImage(blob){
  return new Promise((res, rej)=>{
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = ()=>{ URL.revokeObjectURL(url); res(img); };
    img.onerror = (e)=>{ URL.revokeObjectURL(url); rej(e); };
    img.src = url;
  });
}
function downloadBlob(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
}

/* manual download for removed PNG */
dlRemoved.addEventListener('click', ()=>{
  if(!removedBlob) return alert('No removed image available. Click Remove Background first.');
  downloadBlob(removedBlob, 'removed_bg.png');
});

/* passport composite & preview functions (same as earlier) */
function compositePassport(personImg){
  const OUT_W = 450, OUT_H = 570;
  const c = document.createElement('canvas'); c.width = OUT_W; c.height = OUT_H;
  const cctx = c.getContext('2d');

  let bg = bgSel.value;
  if(bg === 'custom') bg = bgColor.value || '#6ba0e6';
  cctx.fillStyle = bg; cctx.fillRect(0,0,OUT_W,OUT_H);

  const srcRatio = personImg.width / personImg.height;
  const destRatio = OUT_W / OUT_H;
  let drawW, drawH;
  if(srcRatio > destRatio){
    drawH = OUT_H; drawW = Math.round(personImg.width * (OUT_H / personImg.height));
  } else {
    drawW = OUT_W; drawH = Math.round(personImg.height * (OUT_W / personImg.width));
  }
  const dx = Math.round((OUT_W - drawW) / 2), dy = Math.round((OUT_H - drawH) / 2);
  cctx.drawImage(personImg, dx, dy, drawW, drawH);

  applyBrightnessContrast(c, Number(brightness.value), Number(contrast.value));
  despillCanvas(c, bg, 0.88);

  return c;
}
function showPassportPreview(canvas){
  latestPassportCanvas = canvas;
  preview.width = Math.min(420, canvas.width);
  preview.height = Math.round(preview.width * canvas.height / canvas.width);
  ctx.clearRect(0,0,preview.width,preview.height);
  ctx.drawImage(canvas, 0,0, canvas.width, canvas.height, 0,0, preview.width, preview.height);
  dlPng.disabled = false; dlJpg.disabled = false; dlPsd.disabled = false;
}

/* image ops */
function applyBrightnessContrast(canvas, bright=0, contrastVal=0){
  const ctx2 = canvas.getContext('2d');
  const img = ctx2.getImageData(0,0,canvas.width,canvas.height);
  const data = img.data;
  const b = bright;
  const c = contrastVal/100;
  const factor = (259 * (c*255 + 255)) / (255 * (259 - c*255) || 1);
  for(let i=0;i<data.length;i+=4){
    data[i] = clamp(factor * (clamp(data[i] + b) - 128) + 128);
    data[i+1] = clamp(factor * (clamp(data[i+1] + b) - 128) + 128);
    data[i+2] = clamp(factor * (clamp(data[i+2] + b) - 128) + 128);
  }
  ctx2.putImageData(img,0,0);
}
function despillCanvas(canvas, bgHex='#6ba0e6', strength=0.85){
  const ctx2 = canvas.getContext('2d');
  const img = ctx2.getImageData(0,0,canvas.width,canvas.height);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    if(b > r + 12 && b > g + 12){
      const diff = b - Math.max(r,g);
      const reduce = Math.round(diff * strength);
      d[i+2] = clamp(b - reduce);
      d[i] = clamp(r + Math.round(reduce * 0.05));
      d[i+1] = clamp(g + Math.round(reduce * 0.03));
    }
  }
  ctx2.putImageData(img,0,0);
}
function clamp(v){ return Math.max(0, Math.min(255, Math.round(v))); }
function rgbToHex(r,g,b){ return '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join(''); }

/* downloads for passport */
dlPng.addEventListener('click', ()=> {
  if(!latestPassportCanvas) return alert('Generate passport first');
  latestPassportCanvas.toBlob(b => downloadBlob(b, 'passport.png'), 'image/png');
});
dlJpg.addEventListener('click', ()=> {
  if(!latestPassportCanvas) return alert('Generate passport first');
  latestPassportCanvas.toBlob(b => downloadBlob(b, 'passport.jpg'), 'image/jpeg', 0.92);
});
dlPsd.addEventListener('click', ()=> {
  if(!latestPassportCanvas) return alert('Generate passport first');
  try{
    const ag = window['agPsd'];
    const psd = { width: latestPassportCanvas.width, height: latestPassportCanvas.height, children: [ { name: 'Layer 1', left:0, top:0, right: latestPassportCanvas.width, bottom: latestPassportCanvas.height, canvas: latestPassportCanvas } ] };
    const ab = ag.encodePsd(psd);
    const blob = new Blob([ab], { type: 'application/octet-stream' });
    downloadBlob(blob, 'passport.psd');
  }catch(e){
    console.error(e);
    alert('PSD export failed: ' + (e.message || e));
  }
});

/* reset */
resetBtn.addEventListener('click', ()=> {
  uploadedFile = null; origImage = null; removedBlob = null; latestPassportCanvas = null; fileInput.value = '';
  ctx.clearRect(0,0,preview.width,preview.height);
  dlRemoved.disabled = dlPng.disabled = dlJpg.disabled = dlPsd.disabled = true;
  updatePreviewBackground();
});

/* utility drawChecker */
function drawChecker(width, height, size=12){
  const cols = Math.ceil(width / size), rows = Math.ceil(height / size);
  const cw = preview.width / cols, ch = preview.height / rows;
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      ctx.fillStyle = ((x+y)%2===0) ? '#c9dfe6' : '#f5fbff';
      ctx.fillRect(x*cw, y*ch, cw, ch);
    }
  }
}
</script>
</body>
</html>

